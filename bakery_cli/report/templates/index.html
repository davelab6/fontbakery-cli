<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Summary</title>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" />
</head>
<body>
    <div class="container">
        <ul class="nav nav-tabs">
          <li class="active"><a href="index.html">Summary</a></li>
          <li><a href="upstream.html">Upstream Tests</a></li>
          <li><a href="tests.html">Downstream Tests</a></li>
          <li><a href="buildlog.html">Build Log</a></li>
          <li><a href="metadata.html">METADATA.json</a></li>
          <li><a href="bakery-yaml.html">bakery.yaml</a></li>
          <li><a href="description.html">Description</a></li>
        </ul>
        {% set map = {'success': 'OK', 'failure': 'FAIL', 'error': 'ERROR', 'fixed': 'FIXED'} %}
        {% set testTypes = { 'error': 'danger', 'failure': 'error', 'success': 'success', 'fixed': 'info'} %}

        {% for font in fonts %}
        <h4>{{ font.name }}</h4>

        <style>
            @font-face {font-family: {{ font.basename }}; src: url({{ font.path }});}
            .face{{ loop.index }} {font-family: {{ font.basename }}; font-size: 24pt;}
        </style>

        <div class="face{{ loop.index }}">
            Grumpy wizards make toxic brew for the evil Queen and Jack
        </div>
        {% endfor %}
        {% set map = {'success': 'OK', 'failure': 'FAIL', 'error': 'ERROR', 'fixed': 'FIXED'} %}
        {% set testTypes = { 'error': 'danger', 'failure': 'error', 'success': 'success', 'fixed': 'info'} %}
        {% for font in tests.keys() %}
          {% set blockers = filter_by_results_with_tag(tests[font], 'required', 'fixed', 'failure') %}
          {% if blockers %}
            <h3>Blockers</h3>
            <div id="piechartSum"></div>
            <table class="table table-striped table-bordered table-condensed tablesorter">
                <thead>
                <tr>
                  <th>Category</th>
                  <th>Description</th>
                  <th>File</th>
                  <th>Result</th>
                  <th>Status</th>
                </tr>
                </thead>
                  <tbody>
                  {% for blocker in blockers %}
                    {%- for testType, icon in testTypes.iteritems() | sort %}
                          <tr class="apopover" data-placement="top" data-content="{{ blocker.name|replace('.','/') }}.py:{{ blocker.methodName }}()">
                            <td>{{ blocker['tags']|join(', ') }}</td>
                            <td>{{ blocker['methodDoc']|default('None') }}</td>
                            <td>{{ blocker.name }}</td>
                            <td>{{ blocker['err_msg'] }}</td>
                            <td>{{ map[testType] }}</td>
                          </tr>
                    {%- endfor %}
                  {% endfor %}
                  </tbody>
                  </table>
          {% endif %}
        {% endfor %}
        <h4>Vertical metrics</h4>
        <table class="table-striped table-bordered table-condensed tablesorter">
          <thead>
          <tr>
            <th></th>
            <th>{{ vhead[1] }}</th>
          </tr>
          </thead>

          {% for k, v in vmet.iteritems() %}
          <tr>
            <td>{{ k }}</td>
            <td class="text-right">{{ v[0] }}</td>
          </tr>
          {% endfor %}
        </table>

        <h4>TTF Table Sizes</h4>
        {% for table in ttftablesizes[0] %}
          <div id="ttftablesizes-{{loop.index}}"></div>
        {% endfor %}
        <h4>TTF Table Average Sizes</h4>
        <div id="ttftablesizesGrouped"></div>
        <div id="ttftablesizesAggregated"></div>

        <table class="table-striped table-bordered table-condensed tablesorter">
            <tr>
                <th></th>
                {% for f in ttftablesizes[1] %}
                <th>{{ f }}</th>
                {% endfor %}
            </tr>

            {% for table in ttftablesizes[0] %}{# loop for list of available tables #}
            <tr>
                <td>{{ table }}</td>
                {% for f in ttftablesizes[1] %}
                    <td class="text-right">{{ ttftablesizes[1][f].get(table, '') }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>

        {% if autohinting_sizes %}
        <h4>ttfautohint filesize impact statistic</h4>
        <table class="table-striped table-bordered table-condensed tablesorter">
        {% for t in autohinting_sizes %}
            <tr>
                <th colspan="2">{{ t['fontname'] }}</th>
            </tr>
            <tr>
                <td>Before</td>
                <td>{{ t['origin'] }}</td>
            </tr>
            <tr>
                <td>After</td>
                <td>{{ t['processed'] }}</td>
            </tr>
            <tr>
                <td>Increase</td>
                <td>{{ t['processed'] - t['origin'] }}</td>
            </tr>
            <tr>
                <td>Change</td>
                <td>{{ '{:.3f}x'.format(t['processed'] / t['origin']) }}</td>
            </tr>
        {% endfor %}
        </table>
        {% endif %}

        <h4>Font Description</h4>

        <table class="table-striped table-bordered table-condensed tablesorter">
          <thead>
            <tr>
              <th></th>
              {% for font, fontaine in fontaineFonts %}
              <th>{{ font }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>Common Name</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.common_name }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Full Name</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine._full_name }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>PostScript Name</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine._postscript }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Subfamily</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.sub_family }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Weight</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.weight }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Version</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.version }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>UniqueID</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine._unique_id }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Copyright</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.copyright }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>License</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.license }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>License URL</th>
              {% for font, fontaine in fontaineFonts %}
              <td><a href="{{ fontaine.license_url }}">{{ fontaine.license_url }}</a></td>
              {% endfor %}
            </tr>
            <tr>
              <th>Designer</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.designer }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Designer URL</th>
              {% for font, fontaine in fontaineFonts %}
              <td><a href="{{ fontaine.designer_url }}">{{ fontaine.designer_url }}</a></td>
              {% endfor %}
            </tr>
            <tr>
              <th>Vendor</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.vendor }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>Vendor URL</th>
              {% for font, fontaine in fontaineFonts %}
              <td><a href="{{ fontaine.vendor_url }}">{{ fontaine.vendor_url }}</a></td>
              {% endfor %}
            </tr>
            <tr>
              <th>has_fixed_sizes</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.has_fixed_sizes }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>is_fixed_width</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.is_fixed_width }}</td>
              {% endfor %}
            </tr>
            <tr>
              <th>style_flags</th>
              {% for font, fontaine in fontaineFonts %}
              <td>{{ fontaine.style_flags }}</td>
              {% endfor %}
            </tr>
          </tbody>
        </table>

        <h4>Font Coverage characters</h4>

        <table class="table table-striped table-bordered table-condensed tablesorter">
          <thead>
            <tr>
              <th width='10%'>Font</th>
              <th width='10%'>Character Set</th>
              <th>Coverage</th>
              <th width='80%'>Missing Characters</th>
            </tr>
          </thead>
          <tbody>
          {% for font, charmap, support, coverage, missingchars in get_orthography(fontaineFonts) %}
            <tr class="{{ support | replace('full','success') | replace('partial','info') | replace('fragmentary','warning') | replace('unsupported','error') }}">
              <td style="white-space: nowrap">{{ font }}</td>
              <td style="white-space: nowrap">{{ charmap.common_name }}
              <td class="text-right">{{ coverage }}
              <td>{% if coverage != 100 and missingchars %}
              <button class="btn btn-success" toggle="toggle">Show</button>
                <div style="display: none;">
                {% for item in missingchars %}
                  {{ '&#{};'.format(item)|safe }}
                {% endfor %}
                </div>{% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
    </div>
</body>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.17.7/js/jquery.tablesorter.min.js"></script>
<script>
function toggleMissing() {
  var btn = $(this);
  btn.next('div').toggle('hide', function() {
    if ($(this).is(':hidden')) {
        btn.text('Show');
      } else {
        btn.text('Hide');
      }
    });
}

$(function(){
    $('.tablesorter').tablesorter();
    $('.apopover').each(function (index, item) {
        $(item).popover();
    });
    $('button[toggle]').on('click', toggleMissing);
});
</script>
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
  google.load("visualization", "1", {packages:["corechart"]});
  google.setOnLoadCallback(drawChart);
  function drawChart() {

    {% set chartsum = {"success": 0, "failure": 0, "fixed": 0, "error": 0} %}
    {%- for font in tests.keys() %}

    {% set chartsum = {
      "success": chartsum.success + tests[font]['success']|length,
      "error": chartsum.error + tests[font]['error']|length,
      "failure": chartsum.failure + tests[font]['failure']|length,
      "fixed": chartsum.fixed + tests[font]['fixed']|length,
      } %}

    {% if loop.last %}

    var data = google.visualization.arrayToDataTable([
        ['Tests', '#'],
        ['Success {{ chartsum['success'] }}', {{ chartsum['success'] }}],
        ['Fixed {{ chartsum['fixed'] }}', {{ chartsum['fixed'] }}],
        ['Failed {{ chartsum['failure'] }}', {{ chartsum['failure'] }}],
        ['Error {{ chartsum['error'] }}', {{ chartsum['error'] }}]
    ]);

    var options = {
      title: "Summary chart",
      is3D: true,
      colors: ['#468847', '#3a87ad', '#b94a48', '#c09853'],
    };

    var chart = new google.visualization.PieChart(document.getElementById('piechartSum'));
    chart.draw(data, options);
    {% endif %}
    {% endfor %}

    {% for font in ttftablesizes[1] %}
      {% set average = average_table_size(ttftablesizes[1][font]) %}
      {% set tables = font_table_to_google_data_list(ttftablesizes[1][font]) %}

      var data = google.visualization.arrayToDataTable({{ ([["Table", "Size"]] + tables)|safe }});
      var chart = new google.visualization.LineChart(document.getElementById('ttftablesizes-{{loop.index}}'));

      var options = {
        title: "Table sizes ({{font}})",
        is3D: true,
        vAxis: {
          gridlines:{count:5},
          minorGridlines: {count:2},
          viewWindowMode:'pretty',
          title: "bytes",
          viewWindow: {
            min:0.0
          }
        },
        hAxis: {
          slantedText: true
        },
        height: 500
      };
      chart.draw(data, options);
    {% endfor %}

    var data = google.visualization.arrayToDataTable({{ ([["Table", "Size"]] + ttftablesizes_mean)|safe }});
    var chart = new google.visualization.LineChart(document.getElementById('ttftablesizesGrouped'));

    var options = {
      title: "Average Table Sizes",
      is3D: true,
      vAxis: {
        title: "bytes"
      },
      hAxis: {
        slantedText: true
      },
      height: 500
    };
    chart.draw(data, options);

    var headings = $.merge( ["Table", "Average"], {{ttftablesizes_grouped.fonts}} );
    var aggregated_table = [];

    aggregated_table.push(headings);

    $({{ttftablesizes_grouped.tables}}).each(function(i){
      aggregated_table.push(this)
    });

    var data = google.visualization.arrayToDataTable(aggregated_table);
    var chart = new google.visualization.LineChart(document.getElementById('ttftablesizesAggregated'));
     var options = {
        title: "Aggregated data",
        is3D: true,
        vAxis: {
          title: "Size (bytes)"
        },
        hAxis: {
          slantedText: true
        },
        height: 500
      };
      chart.draw(data, options);
  }
</script>
<style>
    .popover {
        max-width: 1980px;
        font-family: Courier;
    }
</style>
</html>
